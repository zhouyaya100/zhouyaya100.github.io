<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®‡å®™å¤©æ–‡æ—¶é’Ÿ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      overflow: hidden;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #000;
      color: white;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ä¸»ç”»å¸ƒ */
    #main-canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -2;
    }

    /* å¤©ä½“ï¼ˆå¤ªé˜³/æœˆäº®ï¼‰ */
    .celestial-body {
      position: absolute;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 5;
    }
    #sun { width: 90px; height: 90px; background: radial-gradient(circle, #FFD700, #FF8C00); box-shadow: 0 0 70px #FFA500; opacity: 0; }
    #moon { width: 70px; height: 70px; background: radial-gradient(circle, #F0F0F0, #D3D3D3); box-shadow: 0 0 30px rgba(200,200,255,0.4); opacity: 0; clip-path: circle(50% at 50% 50%); }

    /* ä¿¡æ¯é¢æ¿ */
    .info-panel {
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 28px;
      text-align: center;
      max-width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
    }
    h1 {
      font-size: 2.2em;
      margin-bottom: 16px;
      background: linear-gradient(90deg, #FFD700, #87CEEB);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .time { font-size: 4.8em; font-weight: 800; letter-spacing: 3px; font-family: 'Courier New', monospace; text-shadow: 0 0 12px rgba(255,255,255,0.7); margin: 14px 0; }
    .date-lunar, .weather, .location { font-size: 1.4em; margin: 8px 0; opacity: 0.92; }

    /* éšè”½è®¾ç½®æŒ‰é’® */
    #settings-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 100;
      transition: background 0.2s;
    }
    #settings-btn:hover { background: rgba(255,255,255,0.25); }
    #settings-btn::after {
      content: "âš™ï¸";
      font-size: 18px;
    }

    /* è®¾ç½®é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ */
    #settings-panel {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: rgba(20, 20, 30, 0.92);
      padding: 16px;
      border-radius: 12px;
      width: 260px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      z-index: 99;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    #settings-panel.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    #settings-panel input {
      width: 100%;
      padding: 8px 10px;
      margin-top: 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: white;
    }
    #settings-panel button {
      width: 100%;
      margin-top: 10px;
      padding: 6px;
      background: #4CAF50;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    #settings-panel button:hover { background: #45a049; }

    @media (max-width: 768px) {
      .time { font-size: 3em; }
      h1 { font-size: 1.8em; }
      .date-lunar, .weather, .location { font-size: 1.1em; }
      #settings-panel { width: 200px; bottom: 60px; }
    }
  </style>
</head>
<body>
  <canvas id="main-canvas"></canvas>
  <div id="sun" class="celestial-body"></div>
  <div id="moon" class="celestial-body"></div>

  <div class="info-panel">
    <h1>å®‡å®™å¤©æ–‡æ—¶é’Ÿ</h1>
    <div class="time" id="time">--:--:--</div>
    <div class="date-lunar" id="date-lunar">åŠ è½½ä¸­â€¦</div>
    <div class="weather" id="weather">ğŸŒ¤ï¸ è·å–å¤©æ°”ä¸­â€¦</div>
    <div class="location" id="location">ğŸ“ å”å±±</div>
  </div>

  <!-- éšè”½è®¾ç½® -->
  <div id="settings-btn" onclick="toggleSettings()"></div>
  <div id="settings-panel">
    <input type="text" id="city-input" placeholder="åŸå¸‚æˆ–ç»çº¬åº¦ (å¦‚: åŒ—äº¬ æˆ– 39.9,116.4)" />
    <button onclick="changeLocation()">åº”ç”¨</button>
  </div>

  <!-- å†œå†æ•°æ® -->
  <script>
    const lunarData = [0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04afb,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0];

    function getLunarDate(solarYear, solarMonth, solarDay) {
      const baseDate = new Date(1900, 0, 31);
      const targetDate = new Date(solarYear, solarMonth - 1, solarDay);
      const days = Math.floor((targetDate - baseDate) / 86400000);
      let lunarYear = 1900, lunarMonth = 1, lunarDay = 1, tempDays = days;
      while (tempDays > 0) {
        const yearDays = getYearDays(lunarYear);
        if (tempDays >= yearDays) { tempDays -= yearDays; lunarYear++; }
        else {
          const leapMonth = getLeapMonth(lunarYear);
          let month = 1;
          while (month <= 12) {
            let monthDays = getMonthDays(lunarYear, month);
            if (leapMonth > 0 && month === leapMonth + 1) {
              monthDays = getLeapMonthDays(lunarYear);
              lunarMonth = -leapMonth;
            } else lunarMonth = month;
            if (tempDays < monthDays) { lunarDay = tempDays + 1; break; }
            tempDays -= monthDays; month++;
          }
          break;
        }
      }
      return { year: lunarYear, month: lunarMonth, day: lunarDay };
    }
    function getYearDays(year) {
      let sum = 348;
      for (let i = 0x8000; i > 0x8; i >>= 1) if ((lunarData[year - 1900] & i) !== 0) sum++;
      return sum + (getLeapMonth(year) > 0 ? getLeapMonthDays(year) : 0);
    }
    function getLeapMonth(year) { return lunarData[year - 1900] & 0xf; }
    function getMonthDays(year, month) { return (lunarData[year - 1900] & (0x10000 >> month)) ? 30 : 29; }
    function getLeapMonthDays(year) { return (lunarData[year - 1900] & 0x10000) ? 30 : 29; }
    function getMoonPhase(lunarDay) {
      if (lunarDay <= 15) return (lunarDay - 1) / 14;
      else return (29 - lunarDay) / 14;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

  <script>
    // ========== å…¨å±€çŠ¶æ€ ==========
    let LAT = 39.63, LNG = 118.18, cityName = "å”å±±";
    let auroraActive = false;
    let settingsVisible = false;
    let lastRender = 0;
    let stars = []; // å­˜å‚¨æ˜Ÿæ˜Ÿæ•°æ®

    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const sunEl = document.getElementById('sun');
    const moonEl = document.getElementById('moon');

    // è¡Œæ˜Ÿ & æ˜Ÿåº§æ•°æ®
    const planets = [
      { au: 0.39, color: '#B7B8B9', speed: 4.15 },
      { au: 0.72, color: '#E6C79C', speed: 1.60 },
      { au: 1.00, color: '#4CAF50', speed: 0.986 },
      { au: 1.52, color: '#CD5C5C', speed: 0.53 }
    ];

    const constellations = [
      { stars: [[100,200],[120,180],[140,200],[130,230],[110,230]], lines: [[0,1],[1,2],[1,3],[1,4]], label: ["çŒæˆ·åº§", 125, 160] },
      { stars: [[300,100],[320,110],[340,130],[330,150],[310,160],[290,150],[280,130]], lines: [[0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[2,5]], label: ["åŒ—æ–—ä¸ƒæ˜Ÿ", 310, 80] }
    ];

    // æ–°å¢ï¼šåˆå§‹åŒ–æ˜Ÿæ˜Ÿ
    function initStars(width, height) {
      stars = [];
      const count = 600;
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * width,
          y: Math.random() * height,
          size: Math.random() * 1.5,
          alpha: 0.3 + Math.random() * 0.7
        });
      }
    }

    // æ–°å¢ï¼šæ£€æŸ¥æå…‰çŠ¶æ€
    function checkAurora() {
      auroraActive = Math.abs(LAT) > 55;
    }

    // ========== åˆå§‹åŒ– ==========
    function init() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      updateTime();
      updateCelestial();
      fetchWeather();
    }

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      checkAurora();
      initStars(canvas.width, canvas.height); // é‡æ–°ç”Ÿæˆæ˜Ÿæ˜Ÿé€‚é…æ–°å°ºå¯¸
    }

    // ========== æ¸²æŸ“ä¸»ç”»å¸ƒ ==========
    function renderMainCanvas(timestamp) {
      if (!lastRender) lastRender = timestamp;
      const delta = timestamp - lastRender;
      lastRender = timestamp;

      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      // èƒŒæ™¯æ¸å˜
      const now = new Date();
      const times = SunCalc.getTimes(now, LAT, LNG);
      const isDay = now > times.sunrise && now < times.sunset;
      const bgTop = isDay ? '#87CEEB' : '#0c1445';
      const bgBottom = isDay ? '#FFDEAD' : '#1a2a6c';
      const gradient = ctx.createLinearGradient(0, 0, 0, h);
      gradient.addColorStop(0, bgTop);
      gradient.addColorStop(1, bgBottom);
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, w, h);

      const centerX = w / 2, centerY = h / 2;
      const scale = Math.min(w, h) * 0.35;

      // æ˜Ÿç©ºï¼ˆä»…å¤œæ™šï¼‰
      if (!isDay) {
        ctx.fillStyle = '#fff';
        for (const star of stars) {
          ctx.globalAlpha = star.alpha;
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;

        // æ˜Ÿåº§
        constellations.forEach(c => {
          ctx.strokeStyle = 'rgba(255,255,255,0.6)';
          ctx.lineWidth = 1;
          c.lines.forEach(([i, j]) => {
            ctx.beginPath();
            ctx.moveTo(...c.stars[i]);
            ctx.lineTo(...c.stars[j]);
            ctx.stroke();
          });
          c.stars.forEach(([x, y]) => {
            ctx.beginPath();
            ctx.arc(x, y, 2.5, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
          });
          ctx.fillStyle = 'rgba(255,255,255,0.85)';
          ctx.font = '13px Arial';
          ctx.fillText(c.label[0], c.label[1], c.label[2]);
        });
      }

      // è¡Œæ˜Ÿè½¨é“ï¼ˆä»…å¤§å±ï¼‰
      if (w > 800) {
        planets.forEach(p => {
          const r = p.au * scale;
          ctx.beginPath();
          ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
          ctx.strokeStyle = 'rgba(255,255,255,0.12)';
          ctx.stroke();

          // è¡Œæ˜Ÿä½ç½®
          const angle = (now.getTime() / 86400000) * p.speed * (Math.PI / 180);
          const x = centerX + r * Math.cos(angle);
          const y = centerY + r * Math.sin(angle);
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fillStyle = p.color;
          ctx.fill();
        });
      }

      // æå…‰
      if (auroraActive && !isDay) {
        const waves = 4;
        for (let i = 0; i < waves; i++) {
          const offset = i * 1.5;
          const speed = 0.015;
          const hue = 120 + Math.sin(timestamp * 0.001 + i) * 30;
          ctx.beginPath();
          ctx.moveTo(0, h);
          for (let x = 0; x <= w; x += 8) {
            const y = h - (80 + Math.sin(x * 0.01 + offset + timestamp * speed) * 60);
            ctx.lineTo(x, y);
          }
          ctx.lineTo(w, h);
          ctx.closePath();
          ctx.fillStyle = `hsla(${hue}, 80%, 55%, ${0.25 + i * 0.05})`;
          ctx.fill();
        }
      }

      requestAnimationFrame(renderMainCanvas);
    }

    // ========== æ›´æ–°å¤©ä½“ä½ç½® ==========
    function updateCelestial() {
      const now = new Date();
      const posSun = SunCalc.getPosition(now, LAT, LNG);
      const lunar = getLunarDate(now.getFullYear(), now.getMonth() + 1, now.getDate());
      const moonPhase = getMoonPhase(lunar.day);
      const times = SunCalc.getTimes(now, LAT, LNG);
      const isDay = now > times.sunrise && now < times.sunset;

      // å¤ªé˜³
      const sunAz = (posSun.azimuth * 180 / Math.PI + 180) % 360;
      const sunAlt = posSun.altitude * 180 / Math.PI;
      const sunX = (sunAz / 360) * window.innerWidth;
      const sunY = window.innerHeight - (sunAlt + 90) / 180 * window.innerHeight;
      sunEl.style.left = `${sunX}px`;
      sunEl.style.top = `${sunY}px`;
      sunEl.style.opacity = Math.max(0, Math.min(1, (sunAlt + 10) / 30));

      // æœˆäº®
      const moonX = window.innerWidth - sunX;
      const moonY = sunY + 60;
      moonEl.style.left = `${moonX}px`;
      moonEl.style.top = `${moonY}px`;
      moonEl.style.opacity = isDay ? 0 : 0.95;

      // æœˆç›¸
      if (moonPhase < 0.5) {
        const clipX = 50 + 50 * (1 - moonPhase * 2);
        moonEl.style.clipPath = `polygon(0 0, ${clipX}% 0, ${clipX}% 100%, 0 100%)`;
      } else {
        const clipX = 50 * (moonPhase - 0.5) * 2;
        moonEl.style.clipPath = `polygon(${clipX}% 0, 100% 0, 100% 100%, ${clipX}% 100%)`;
      }
    }

    // ========== æ—¶é—´ & å¤©æ°” ==========
    function updateTime() {
      const now = new Date();
      document.getElementById('time').textContent = now.toLocaleTimeString('zh-CN', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
      });

      const lunar = getLunarDate(now.getFullYear(), now.getMonth() + 1, now.getDate());
      const monthNames = ["æ­£æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","å†¬æœˆ","è…Šæœˆ"];
      const dayNames = ["åˆä¸€","åˆäºŒ","åˆä¸‰","åˆå››","åˆäº”","åˆå…­","åˆä¸ƒ","åˆå…«","åˆä¹","åˆå",
        "åä¸€","åäºŒ","åä¸‰","åå››","åäº”","åå…­","åä¸ƒ","åå…«","åä¹","äºŒå",
        "å»¿ä¸€","å»¿äºŒ","å»¿ä¸‰","å»¿å››","å»¿äº”","å»¿å…­","å»¿ä¸ƒ","å»¿å…«","å»¿ä¹","ä¸‰å"];
      let monthStr = monthNames[Math.abs(lunar.month) - 1];
      if (lunar.month < 0) monthStr = "é—°" + monthStr;
      document.getElementById('date-lunar').textContent = `${lunar.year}å¹´ ${monthStr} ${dayNames[lunar.day - 1]}`;
    }

    async function fetchWeather() {
      try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}&current_weather=true&timezone=auto`);
        const data = await res.json();
        if (data.current_weather) {
          const temp = Math.round(data.current_weather.temperature);
          const code = data.current_weather.weathercode;
          let emoji = 'ğŸŒ¤ï¸';
          if (code === 0) emoji = 'â˜€ï¸';
          else if ([1,2,3].includes(code)) emoji = 'ğŸŒ¤ï¸';
          else if (code >= 51 && code <= 57) emoji = 'ğŸŒ§ï¸';
          else if (code >= 61 && code <= 67) emoji = 'â„ï¸';
          else if (code >= 80) emoji = 'â›ˆï¸';
          document.getElementById('weather').innerHTML = `${emoji} ${cityName} ${temp}Â°C`;
        }
      } catch (e) {
        document.getElementById('weather').textContent = 'ğŸŒ¦ï¸ å¤©æ°”è·å–å¤±è´¥';
      }
    }

    // ========== è®¾ç½®é¢æ¿ ==========
    function toggleSettings() {
      settingsVisible = !settingsVisible;
      document.getElementById('settings-panel').classList.toggle('active', settingsVisible);
    }

    async function changeLocation() {
      const input = document.getElementById('city-input').value.trim();
      if (!input) return;

      let lat, lng, name;
      if (input.includes(',')) {
        const parts = input.split(',').map(p => parseFloat(p.trim()));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
          lat = parts[0]; lng = parts[1]; name = `è‡ªå®šä¹‰ (${lat.toFixed(2)}, ${lng.toFixed(2)})`;
        }
      } else {
        try {
          const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input)}&format=json&limit=1`;
          const res = await fetch(url);
          const data = await res.json();
          if (data && data[0]) {
            lat = parseFloat(data[0].lat);
            lng = parseFloat(data[0].lon);
            name = data[0].display_name.split(',')[0];
          }
        } catch (e) {}
      }

      if (lat != null && lng != null) {
        LAT = lat; LNG = lng; cityName = name;
        document.getElementById('location').textContent = `ğŸ“ ${cityName}`;
        document.getElementById('city-input').value = '';
        checkAurora();
        fetchWeather();
        updateCelestial();
        toggleSettings(); // è‡ªåŠ¨æ”¶èµ·
      } else {
        alert('âŒ æœªæ‰¾åˆ°è¯¥ä½ç½®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆåŸå¸‚åæˆ–ç»çº¬åº¦ï¼ˆå¦‚ï¼šåŒ—äº¬ æˆ– 39.9,116.4ï¼‰');
      }
    }

    // ========== å¯åŠ¨ ==========
    init();
    requestAnimationFrame(renderMainCanvas);
    setInterval(updateTime, 1000);
    setInterval(updateCelestial, 2000);
    setInterval(fetchWeather, 600000); // 10åˆ†é’Ÿ
  </script>
</body>
</html>
